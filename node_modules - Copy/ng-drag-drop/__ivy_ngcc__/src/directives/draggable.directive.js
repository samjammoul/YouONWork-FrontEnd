"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var ng_drag_drop_service_1 = require("../services/ng-drag-drop.service");
var dom_helper_1 = require("../shared/dom-helper");
var ɵngcc0 = require('@angular/core');
var Draggable = /** @class */ (function () {
    function Draggable(el, renderer, ng2DragDropService, zone) {
        this.el = el;
        this.renderer = renderer;
        this.ng2DragDropService = ng2DragDropService;
        this.zone = zone;
        /**
         * Currently not used
         */
        this.dragEffect = 'move';
        /**
         * Defines compatible drag drop pairs. Values must match both in draggable and droppable.dropScope.
         */
        this.dragScope = 'default';
        /**
         * The CSS class applied to a draggable element. If a dragHandle is defined then its applied to that handle
         * element only. By default it is used to change the mouse over pointer.
         */
        this.dragHandleClass = 'drag-handle';
        /**
         * CSS class applied on the source draggable element while being dragged.
         */
        this.dragClass = 'drag-border';
        /**
         * CSS class applied on the drag ghost when being dragged.
         */
        this.dragTransitClass = 'drag-transit';
        /**
         * Event fired when Drag is started
         */
        this.onDragStart = new core_1.EventEmitter();
        /**
         * Event fired while the element is being dragged
         */
        this.onDrag = new core_1.EventEmitter();
        /**
         * Event fired when drag ends
         */
        this.onDragEnd = new core_1.EventEmitter();
        /**
         * @private
         * Backing field for the dragEnabled property
         */
        this._dragEnabled = true;
    }
    Object.defineProperty(Draggable.prototype, "dragImage", {
        get: function () {
            return this._dragImage;
        },
        /**
         * The url to image that will be used as custom drag image when the draggable is being dragged.
         */
        set: function (value) {
            this._dragImage = value;
            this.dragImageElement = new Image();
            this.dragImageElement.src = this.dragImage;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Draggable.prototype, "dragEnabled", {
        get: function () {
            return this._dragEnabled;
        },
        /**
         * Defines if drag is enabled. `true` by default.
         */
        set: function (value) {
            this._dragEnabled = value;
            this.applyDragHandleClass();
        },
        enumerable: true,
        configurable: true
    });
    ;
    Draggable.prototype.ngOnInit = function () {
        this.applyDragHandleClass();
    };
    Draggable.prototype.ngOnDestroy = function () {
        this.unbindDragListeners();
    };
    Draggable.prototype.dragStart = function (e) {
        var _this = this;
        if (this.allowDrag()) {
            // This is a kludgy approach to apply CSS to the drag helper element when an image is being dragged.
            dom_helper_1.DomHelper.addClass(this.el, this.dragTransitClass);
            setTimeout(function () {
                dom_helper_1.DomHelper.addClass(_this.el, _this.dragClass);
                dom_helper_1.DomHelper.removeClass(_this.el, _this.dragTransitClass);
            }, 10);
            this.ng2DragDropService.dragData = this.dragData;
            this.ng2DragDropService.scope = this.dragScope;
            // Firefox requires setData() to be called otherwise the drag does not work.
            // We don't use setData() to transfer data anymore so this is just a dummy call.
            if (e.dataTransfer != null) {
                e.dataTransfer.setData('text', '');
            }
            // Set dragImage
            if (this.dragImage) {
                e.dataTransfer.setDragImage(this.dragImageElement, 0, 0);
            }
            e.stopPropagation();
            this.onDragStart.emit(e);
            this.ng2DragDropService.onDragStart.next();
            this.zone.runOutsideAngular(function () {
                _this.unbindDragListener = _this.renderer.listen(_this.el.nativeElement, 'drag', function (dragEvent) {
                    _this.drag(dragEvent);
                });
            });
        }
        else {
            e.preventDefault();
        }
    };
    Draggable.prototype.drag = function (e) {
        this.onDrag.emit(e);
    };
    Draggable.prototype.dragEnd = function (e) {
        this.unbindDragListeners();
        dom_helper_1.DomHelper.removeClass(this.el, this.dragClass);
        this.ng2DragDropService.onDragEnd.next();
        this.onDragEnd.emit(e);
        e.stopPropagation();
        e.preventDefault();
    };
    Draggable.prototype.mousedown = function (e) {
        this.mouseDownElement = e.target;
    };
    Draggable.prototype.allowDrag = function () {
        if (this.dragHandle) {
            return dom_helper_1.DomHelper.matches(this.mouseDownElement, this.dragHandle) && this.dragEnabled;
        }
        else {
            return this.dragEnabled;
        }
    };
    Draggable.prototype.applyDragHandleClass = function () {
        var dragElement = this.getDragHandleElement();
        if (!dragElement) {
            return;
        }
        if (this.dragEnabled) {
            dom_helper_1.DomHelper.addClass(dragElement, this.dragHandleClass);
        }
        else {
            dom_helper_1.DomHelper.removeClass(this.el, this.dragHandleClass);
        }
    };
    Draggable.prototype.getDragHandleElement = function () {
        var dragElement = this.el;
        if (this.dragHandle) {
            dragElement = this.el.nativeElement.querySelector(this.dragHandle);
        }
        return dragElement;
    };
    Draggable.prototype.unbindDragListeners = function () {
        if (this.unbindDragListener) {
            this.unbindDragListener();
        }
    };
    /** @nocollapse */
    Draggable.ctorParameters = function () { return [
        { type: core_1.ElementRef },
        { type: core_1.Renderer2 },
        { type: ng_drag_drop_service_1.NgDragDropService },
        { type: core_1.NgZone }
    ]; };
    Draggable.propDecorators = {
        dragData: [{ type: core_1.Input }],
        dragHandle: [{ type: core_1.Input }],
        dragEffect: [{ type: core_1.Input }],
        dragScope: [{ type: core_1.Input }],
        dragHandleClass: [{ type: core_1.Input }],
        dragClass: [{ type: core_1.Input }],
        dragTransitClass: [{ type: core_1.Input }],
        dragImage: [{ type: core_1.Input }],
        dragEnabled: [{ type: core_1.HostBinding, args: ['draggable',] }, { type: core_1.Input }],
        onDragStart: [{ type: core_1.Output }],
        onDrag: [{ type: core_1.Output }],
        onDragEnd: [{ type: core_1.Output }],
        dragStart: [{ type: core_1.HostListener, args: ['dragstart', ['$event'],] }],
        dragEnd: [{ type: core_1.HostListener, args: ['dragend', ['$event'],] }],
        mousedown: [{ type: core_1.HostListener, args: ['mousedown', ['$event'],] }, { type: core_1.HostListener, args: ['touchstart', ['$event'],] }]
    };
Draggable.ɵfac = function Draggable_Factory(t) { return new (t || Draggable)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2), ɵngcc0.ɵɵdirectiveInject(ng_drag_drop_service_1.NgDragDropService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone)); };
Draggable.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: Draggable, selectors: [["", "draggable", ""]], hostVars: 1, hostBindings: function Draggable_HostBindings(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵlistener("dragstart", function Draggable_dragstart_HostBindingHandler($event) { return ctx.dragStart($event); })("dragend", function Draggable_dragend_HostBindingHandler($event) { return ctx.dragEnd($event); })("mousedown", function Draggable_mousedown_HostBindingHandler($event) { return ctx.mousedown($event); })("touchstart", function Draggable_touchstart_HostBindingHandler($event) { return ctx.mousedown($event); });
    } if (rf & 2) {
        ɵngcc0.ɵɵhostProperty("draggable", ctx.dragEnabled);
    } }, inputs: { dragEffect: "dragEffect", dragScope: "dragScope", dragHandleClass: "dragHandleClass", dragClass: "dragClass", dragTransitClass: "dragTransitClass", dragImage: "dragImage", dragEnabled: "dragEnabled", dragData: "dragData", dragHandle: "dragHandle" }, outputs: { onDragStart: "onDragStart", onDrag: "onDrag", onDragEnd: "onDragEnd" } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(Draggable, [{
        type: core_1.Directive,
        args: [{
                selector: '[draggable]'
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }, { type: ɵngcc0.Renderer2 }, { type: ng_drag_drop_service_1.NgDragDropService }, { type: ɵngcc0.NgZone }]; }, { dragEffect: [{
            type: core_1.Input
        }], dragScope: [{
            type: core_1.Input
        }], dragHandleClass: [{
            type: core_1.Input
        }], dragClass: [{
            type: core_1.Input
        }], dragTransitClass: [{
            type: core_1.Input
        }], onDragStart: [{
            type: core_1.Output
        }], onDrag: [{
            type: core_1.Output
        }], onDragEnd: [{
            type: core_1.Output
        }], dragImage: [{
            type: core_1.Input
        }], dragEnabled: [{
            type: core_1.HostBinding,
            args: ['draggable']
        }, {
            type: core_1.Input
        }], dragStart: [{
            type: core_1.HostListener,
            args: ['dragstart', ['$event']]
        }], dragEnd: [{
            type: core_1.HostListener,
            args: ['dragend', ['$event']]
        }], mousedown: [{
            type: core_1.HostListener,
            args: ['mousedown', ['$event']]
        }, {
            type: core_1.HostListener,
            args: ['touchstart', ['$event']]
        }], dragData: [{
            type: core_1.Input
        }], dragHandle: [{
            type: core_1.Input
        }] }); })();
    return Draggable;
}());
exports.Draggable = Draggable;

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJhZ2dhYmxlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZXMiOlsiZHJhZ2dhYmxlLmRpcmVjdGl2ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BS007QUFDTjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFBTTtBQUNOO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcclxudmFyIGNvcmVfMSA9IHJlcXVpcmUoXCJAYW5ndWxhci9jb3JlXCIpO1xyXG52YXIgbmdfZHJhZ19kcm9wX3NlcnZpY2VfMSA9IHJlcXVpcmUoXCIuLi9zZXJ2aWNlcy9uZy1kcmFnLWRyb3Auc2VydmljZVwiKTtcclxudmFyIGRvbV9oZWxwZXJfMSA9IHJlcXVpcmUoXCIuLi9zaGFyZWQvZG9tLWhlbHBlclwiKTtcclxudmFyIERyYWdnYWJsZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIERyYWdnYWJsZShlbCwgcmVuZGVyZXIsIG5nMkRyYWdEcm9wU2VydmljZSwgem9uZSkge1xyXG4gICAgICAgIHRoaXMuZWwgPSBlbDtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyID0gcmVuZGVyZXI7XHJcbiAgICAgICAgdGhpcy5uZzJEcmFnRHJvcFNlcnZpY2UgPSBuZzJEcmFnRHJvcFNlcnZpY2U7XHJcbiAgICAgICAgdGhpcy56b25lID0gem9uZTtcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBDdXJyZW50bHkgbm90IHVzZWRcclxuICAgICAgICAgKi9cclxuICAgICAgICB0aGlzLmRyYWdFZmZlY3QgPSAnbW92ZSc7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogRGVmaW5lcyBjb21wYXRpYmxlIGRyYWcgZHJvcCBwYWlycy4gVmFsdWVzIG11c3QgbWF0Y2ggYm90aCBpbiBkcmFnZ2FibGUgYW5kIGRyb3BwYWJsZS5kcm9wU2NvcGUuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdGhpcy5kcmFnU2NvcGUgPSAnZGVmYXVsdCc7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogVGhlIENTUyBjbGFzcyBhcHBsaWVkIHRvIGEgZHJhZ2dhYmxlIGVsZW1lbnQuIElmIGEgZHJhZ0hhbmRsZSBpcyBkZWZpbmVkIHRoZW4gaXRzIGFwcGxpZWQgdG8gdGhhdCBoYW5kbGVcclxuICAgICAgICAgKiBlbGVtZW50IG9ubHkuIEJ5IGRlZmF1bHQgaXQgaXMgdXNlZCB0byBjaGFuZ2UgdGhlIG1vdXNlIG92ZXIgcG9pbnRlci5cclxuICAgICAgICAgKi9cclxuICAgICAgICB0aGlzLmRyYWdIYW5kbGVDbGFzcyA9ICdkcmFnLWhhbmRsZSc7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogQ1NTIGNsYXNzIGFwcGxpZWQgb24gdGhlIHNvdXJjZSBkcmFnZ2FibGUgZWxlbWVudCB3aGlsZSBiZWluZyBkcmFnZ2VkLlxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIHRoaXMuZHJhZ0NsYXNzID0gJ2RyYWctYm9yZGVyJztcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBDU1MgY2xhc3MgYXBwbGllZCBvbiB0aGUgZHJhZyBnaG9zdCB3aGVuIGJlaW5nIGRyYWdnZWQuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdGhpcy5kcmFnVHJhbnNpdENsYXNzID0gJ2RyYWctdHJhbnNpdCc7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogRXZlbnQgZmlyZWQgd2hlbiBEcmFnIGlzIHN0YXJ0ZWRcclxuICAgICAgICAgKi9cclxuICAgICAgICB0aGlzLm9uRHJhZ1N0YXJ0ID0gbmV3IGNvcmVfMS5FdmVudEVtaXR0ZXIoKTtcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBFdmVudCBmaXJlZCB3aGlsZSB0aGUgZWxlbWVudCBpcyBiZWluZyBkcmFnZ2VkXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdGhpcy5vbkRyYWcgPSBuZXcgY29yZV8xLkV2ZW50RW1pdHRlcigpO1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEV2ZW50IGZpcmVkIHdoZW4gZHJhZyBlbmRzXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdGhpcy5vbkRyYWdFbmQgPSBuZXcgY29yZV8xLkV2ZW50RW1pdHRlcigpO1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEBwcml2YXRlXHJcbiAgICAgICAgICogQmFja2luZyBmaWVsZCBmb3IgdGhlIGRyYWdFbmFibGVkIHByb3BlcnR5XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdGhpcy5fZHJhZ0VuYWJsZWQgPSB0cnVlO1xyXG4gICAgfVxyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KERyYWdnYWJsZS5wcm90b3R5cGUsIFwiZHJhZ0ltYWdlXCIsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2RyYWdJbWFnZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFRoZSB1cmwgdG8gaW1hZ2UgdGhhdCB3aWxsIGJlIHVzZWQgYXMgY3VzdG9tIGRyYWcgaW1hZ2Ugd2hlbiB0aGUgZHJhZ2dhYmxlIGlzIGJlaW5nIGRyYWdnZWQuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5fZHJhZ0ltYWdlID0gdmFsdWU7XHJcbiAgICAgICAgICAgIHRoaXMuZHJhZ0ltYWdlRWxlbWVudCA9IG5ldyBJbWFnZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmRyYWdJbWFnZUVsZW1lbnQuc3JjID0gdGhpcy5kcmFnSW1hZ2U7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxyXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRHJhZ2dhYmxlLnByb3RvdHlwZSwgXCJkcmFnRW5hYmxlZFwiLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kcmFnRW5hYmxlZDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIERlZmluZXMgaWYgZHJhZyBpcyBlbmFibGVkLiBgdHJ1ZWAgYnkgZGVmYXVsdC5cclxuICAgICAgICAgKi9cclxuICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgICB0aGlzLl9kcmFnRW5hYmxlZCA9IHZhbHVlO1xyXG4gICAgICAgICAgICB0aGlzLmFwcGx5RHJhZ0hhbmRsZUNsYXNzKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxyXG4gICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgICA7XHJcbiAgICBEcmFnZ2FibGUucHJvdG90eXBlLm5nT25Jbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMuYXBwbHlEcmFnSGFuZGxlQ2xhc3MoKTtcclxuICAgIH07XHJcbiAgICBEcmFnZ2FibGUucHJvdG90eXBlLm5nT25EZXN0cm95ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHRoaXMudW5iaW5kRHJhZ0xpc3RlbmVycygpO1xyXG4gICAgfTtcclxuICAgIERyYWdnYWJsZS5wcm90b3R5cGUuZHJhZ1N0YXJ0ID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgICAgIGlmICh0aGlzLmFsbG93RHJhZygpKSB7XHJcbiAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBrbHVkZ3kgYXBwcm9hY2ggdG8gYXBwbHkgQ1NTIHRvIHRoZSBkcmFnIGhlbHBlciBlbGVtZW50IHdoZW4gYW4gaW1hZ2UgaXMgYmVpbmcgZHJhZ2dlZC5cclxuICAgICAgICAgICAgZG9tX2hlbHBlcl8xLkRvbUhlbHBlci5hZGRDbGFzcyh0aGlzLmVsLCB0aGlzLmRyYWdUcmFuc2l0Q2xhc3MpO1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGRvbV9oZWxwZXJfMS5Eb21IZWxwZXIuYWRkQ2xhc3MoX3RoaXMuZWwsIF90aGlzLmRyYWdDbGFzcyk7XHJcbiAgICAgICAgICAgICAgICBkb21faGVscGVyXzEuRG9tSGVscGVyLnJlbW92ZUNsYXNzKF90aGlzLmVsLCBfdGhpcy5kcmFnVHJhbnNpdENsYXNzKTtcclxuICAgICAgICAgICAgfSwgMTApO1xyXG4gICAgICAgICAgICB0aGlzLm5nMkRyYWdEcm9wU2VydmljZS5kcmFnRGF0YSA9IHRoaXMuZHJhZ0RhdGE7XHJcbiAgICAgICAgICAgIHRoaXMubmcyRHJhZ0Ryb3BTZXJ2aWNlLnNjb3BlID0gdGhpcy5kcmFnU2NvcGU7XHJcbiAgICAgICAgICAgIC8vIEZpcmVmb3ggcmVxdWlyZXMgc2V0RGF0YSgpIHRvIGJlIGNhbGxlZCBvdGhlcndpc2UgdGhlIGRyYWcgZG9lcyBub3Qgd29yay5cclxuICAgICAgICAgICAgLy8gV2UgZG9uJ3QgdXNlIHNldERhdGEoKSB0byB0cmFuc2ZlciBkYXRhIGFueW1vcmUgc28gdGhpcyBpcyBqdXN0IGEgZHVtbXkgY2FsbC5cclxuICAgICAgICAgICAgaWYgKGUuZGF0YVRyYW5zZmVyICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGUuZGF0YVRyYW5zZmVyLnNldERhdGEoJ3RleHQnLCAnJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gU2V0IGRyYWdJbWFnZVxyXG4gICAgICAgICAgICBpZiAodGhpcy5kcmFnSW1hZ2UpIHtcclxuICAgICAgICAgICAgICAgIGUuZGF0YVRyYW5zZmVyLnNldERyYWdJbWFnZSh0aGlzLmRyYWdJbWFnZUVsZW1lbnQsIDAsIDApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgIHRoaXMub25EcmFnU3RhcnQuZW1pdChlKTtcclxuICAgICAgICAgICAgdGhpcy5uZzJEcmFnRHJvcFNlcnZpY2Uub25EcmFnU3RhcnQubmV4dCgpO1xyXG4gICAgICAgICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMudW5iaW5kRHJhZ0xpc3RlbmVyID0gX3RoaXMucmVuZGVyZXIubGlzdGVuKF90aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdkcmFnJywgZnVuY3Rpb24gKGRyYWdFdmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmRyYWcoZHJhZ0V2ZW50KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgRHJhZ2dhYmxlLnByb3RvdHlwZS5kcmFnID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB0aGlzLm9uRHJhZy5lbWl0KGUpO1xyXG4gICAgfTtcclxuICAgIERyYWdnYWJsZS5wcm90b3R5cGUuZHJhZ0VuZCA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgdGhpcy51bmJpbmREcmFnTGlzdGVuZXJzKCk7XHJcbiAgICAgICAgZG9tX2hlbHBlcl8xLkRvbUhlbHBlci5yZW1vdmVDbGFzcyh0aGlzLmVsLCB0aGlzLmRyYWdDbGFzcyk7XHJcbiAgICAgICAgdGhpcy5uZzJEcmFnRHJvcFNlcnZpY2Uub25EcmFnRW5kLm5leHQoKTtcclxuICAgICAgICB0aGlzLm9uRHJhZ0VuZC5lbWl0KGUpO1xyXG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgfTtcclxuICAgIERyYWdnYWJsZS5wcm90b3R5cGUubW91c2Vkb3duID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICB0aGlzLm1vdXNlRG93bkVsZW1lbnQgPSBlLnRhcmdldDtcclxuICAgIH07XHJcbiAgICBEcmFnZ2FibGUucHJvdG90eXBlLmFsbG93RHJhZyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAodGhpcy5kcmFnSGFuZGxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBkb21faGVscGVyXzEuRG9tSGVscGVyLm1hdGNoZXModGhpcy5tb3VzZURvd25FbGVtZW50LCB0aGlzLmRyYWdIYW5kbGUpICYmIHRoaXMuZHJhZ0VuYWJsZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kcmFnRW5hYmxlZDtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG4gICAgRHJhZ2dhYmxlLnByb3RvdHlwZS5hcHBseURyYWdIYW5kbGVDbGFzcyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgZHJhZ0VsZW1lbnQgPSB0aGlzLmdldERyYWdIYW5kbGVFbGVtZW50KCk7XHJcbiAgICAgICAgaWYgKCFkcmFnRWxlbWVudCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmRyYWdFbmFibGVkKSB7XHJcbiAgICAgICAgICAgIGRvbV9oZWxwZXJfMS5Eb21IZWxwZXIuYWRkQ2xhc3MoZHJhZ0VsZW1lbnQsIHRoaXMuZHJhZ0hhbmRsZUNsYXNzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGRvbV9oZWxwZXJfMS5Eb21IZWxwZXIucmVtb3ZlQ2xhc3ModGhpcy5lbCwgdGhpcy5kcmFnSGFuZGxlQ2xhc3MpO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBEcmFnZ2FibGUucHJvdG90eXBlLmdldERyYWdIYW5kbGVFbGVtZW50ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBkcmFnRWxlbWVudCA9IHRoaXMuZWw7XHJcbiAgICAgICAgaWYgKHRoaXMuZHJhZ0hhbmRsZSkge1xyXG4gICAgICAgICAgICBkcmFnRWxlbWVudCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKHRoaXMuZHJhZ0hhbmRsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkcmFnRWxlbWVudDtcclxuICAgIH07XHJcbiAgICBEcmFnZ2FibGUucHJvdG90eXBlLnVuYmluZERyYWdMaXN0ZW5lcnMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudW5iaW5kRHJhZ0xpc3RlbmVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMudW5iaW5kRHJhZ0xpc3RlbmVyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuICAgIERyYWdnYWJsZS5kZWNvcmF0b3JzID0gW1xyXG4gICAgICAgIHsgdHlwZTogY29yZV8xLkRpcmVjdGl2ZSwgYXJnczogW3tcclxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RvcjogJ1tkcmFnZ2FibGVdJ1xyXG4gICAgICAgICAgICAgICAgfSxdIH0sXHJcbiAgICBdO1xyXG4gICAgLyoqIEBub2NvbGxhcHNlICovXHJcbiAgICBEcmFnZ2FibGUuY3RvclBhcmFtZXRlcnMgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBbXHJcbiAgICAgICAgeyB0eXBlOiBjb3JlXzEuRWxlbWVudFJlZiB9LFxyXG4gICAgICAgIHsgdHlwZTogY29yZV8xLlJlbmRlcmVyMiB9LFxyXG4gICAgICAgIHsgdHlwZTogbmdfZHJhZ19kcm9wX3NlcnZpY2VfMS5OZ0RyYWdEcm9wU2VydmljZSB9LFxyXG4gICAgICAgIHsgdHlwZTogY29yZV8xLk5nWm9uZSB9XHJcbiAgICBdOyB9O1xyXG4gICAgRHJhZ2dhYmxlLnByb3BEZWNvcmF0b3JzID0ge1xyXG4gICAgICAgIGRyYWdEYXRhOiBbeyB0eXBlOiBjb3JlXzEuSW5wdXQgfV0sXHJcbiAgICAgICAgZHJhZ0hhbmRsZTogW3sgdHlwZTogY29yZV8xLklucHV0IH1dLFxyXG4gICAgICAgIGRyYWdFZmZlY3Q6IFt7IHR5cGU6IGNvcmVfMS5JbnB1dCB9XSxcclxuICAgICAgICBkcmFnU2NvcGU6IFt7IHR5cGU6IGNvcmVfMS5JbnB1dCB9XSxcclxuICAgICAgICBkcmFnSGFuZGxlQ2xhc3M6IFt7IHR5cGU6IGNvcmVfMS5JbnB1dCB9XSxcclxuICAgICAgICBkcmFnQ2xhc3M6IFt7IHR5cGU6IGNvcmVfMS5JbnB1dCB9XSxcclxuICAgICAgICBkcmFnVHJhbnNpdENsYXNzOiBbeyB0eXBlOiBjb3JlXzEuSW5wdXQgfV0sXHJcbiAgICAgICAgZHJhZ0ltYWdlOiBbeyB0eXBlOiBjb3JlXzEuSW5wdXQgfV0sXHJcbiAgICAgICAgZHJhZ0VuYWJsZWQ6IFt7IHR5cGU6IGNvcmVfMS5Ib3N0QmluZGluZywgYXJnczogWydkcmFnZ2FibGUnLF0gfSwgeyB0eXBlOiBjb3JlXzEuSW5wdXQgfV0sXHJcbiAgICAgICAgb25EcmFnU3RhcnQ6IFt7IHR5cGU6IGNvcmVfMS5PdXRwdXQgfV0sXHJcbiAgICAgICAgb25EcmFnOiBbeyB0eXBlOiBjb3JlXzEuT3V0cHV0IH1dLFxyXG4gICAgICAgIG9uRHJhZ0VuZDogW3sgdHlwZTogY29yZV8xLk91dHB1dCB9XSxcclxuICAgICAgICBkcmFnU3RhcnQ6IFt7IHR5cGU6IGNvcmVfMS5Ib3N0TGlzdGVuZXIsIGFyZ3M6IFsnZHJhZ3N0YXJ0JywgWyckZXZlbnQnXSxdIH1dLFxyXG4gICAgICAgIGRyYWdFbmQ6IFt7IHR5cGU6IGNvcmVfMS5Ib3N0TGlzdGVuZXIsIGFyZ3M6IFsnZHJhZ2VuZCcsIFsnJGV2ZW50J10sXSB9XSxcclxuICAgICAgICBtb3VzZWRvd246IFt7IHR5cGU6IGNvcmVfMS5Ib3N0TGlzdGVuZXIsIGFyZ3M6IFsnbW91c2Vkb3duJywgWyckZXZlbnQnXSxdIH0sIHsgdHlwZTogY29yZV8xLkhvc3RMaXN0ZW5lciwgYXJnczogWyd0b3VjaHN0YXJ0JywgWyckZXZlbnQnXSxdIH1dXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIERyYWdnYWJsZTtcclxufSgpKTtcclxuZXhwb3J0cy5EcmFnZ2FibGUgPSBEcmFnZ2FibGU7XHJcbiJdfQ==